<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Geometry of School Spirit</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-contour.v4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #001220; /* Darker Navy */
            --card-bg: #002b4d;
            --text-color: #ffffff;
            --highlight: #00ffcc; /* Neon Cyan */
            --accent: #ff00ff; /* Neon Magenta */
            --secondary: #ffff00; /* Neon Yellow */
            --dim: #3a506b;
            --border: 1px solid rgba(0, 255, 204, 0.3);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            height: 100vh;
            box-sizing: border-box;
            display: grid;
            /* Ratio: 3.5 (Top) : 2 (Strip) : 3.5 (Bottom) */
            grid-template-rows: 3.5fr 2fr 3.5fr; 
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            overflow: hidden; 
        }

        /* --- Grid Areas --- */
        #viz1 { grid-column: 1 / 2; grid-row: 1 / 2; } /* Top Left */
        #viz4 { grid-column: 2 / 3; grid-row: 1 / 2; } /* Top Right */
        
        /* The Middle Strip */
        #middle-strip {
            grid-column: 1 / 3;
            grid-row: 2 / 3;
            display: flex;
            background: rgba(0, 20, 40, 0.8);
            border-top: 2px solid var(--highlight);
            border-bottom: 2px solid var(--highlight);
            align-items: center;
        }

        #viz3 { grid-column: 1 / 2; grid-row: 3 / 4; } /* Bottom Left */
        #viz2 { grid-column: 2 / 3; grid-row: 3 / 4; } /* Bottom Right */

        /* --- Containers --- */
        .viz-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: var(--border);
            display: flex;
            flex-direction: column;
        }

        h3 { 
            margin: 0 0 5px 0; 
            color: var(--highlight); 
            font-weight: 400; 
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--dim);
            padding-bottom: 5px;
        }
        
        .chart-area { flex-grow: 1; position: relative; overflow: hidden; }

        /* --- Middle Strip Sections --- */
        /* Left: Title (2 parts) */
        #strip-title {
            flex: 2;
            padding: 0 20px;
            border-right: 1px solid var(--dim);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #strip-title h1 { margin: 0; font-size: 1.8em; color: var(--highlight); line-height: 1; }
        #strip-title span { font-size: 0.9em; color: #aaa; letter-spacing: 2px; }

        /* Middle: Song Info (10 parts) */
        #strip-info {
            flex: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
        }
        #info-school { font-size: 2.2em; font-weight: bold; color: #fff; margin: 0; text-shadow: 0 0 10px var(--highlight); }
        #info-song { font-size: 1.4em; color: var(--accent); font-style: italic; margin: 5px 0 10px 0; }
        .info-stats { display: flex; gap: 30px; font-size: 0.9em; color: #ccc; }
        .info-stats span b { color: var(--highlight); }
        
        /* Right: Spotify (2 parts) */
        #strip-player {
            flex: 2;
            height: 100%;
            border-left: 1px solid var(--dim);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            background: #000;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- Viz Styling --- */
        .node circle { stroke: #fff; stroke-width: 1.5px; cursor: pointer; transition: all 0.2s; }
        .node circle:hover { stroke: var(--highlight); stroke-width: 3px; filter: drop-shadow(0 0 5px var(--highlight)); }
        
        .dimmed { opacity: 0.15; filter: grayscale(100%); }
        .highlighted { stroke: var(--highlight) !important; opacity: 1 !important; filter: none !important; }

        /* UpSet Matrix */
        .upset-dot { fill: #555; }
        .upset-dot.active { fill: var(--highlight); }
        
        /* Logos in Viz 1 */
        .school-logo {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .school-logo:hover { transform: scale(1.5); z-index: 100; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            border: 1px solid var(--highlight);
        }

        text { fill: #ccc; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="viz1" class="viz-container">
        <h3>Lyrical Ingredients <span style="font-size:0.6em; float:right; color:#888;">Hover logos to see school</span></h3>
        <div class="chart-area" id="upset-horizontal"></div>
    </div>

    <div id="viz4" class="viz-container">
        <h3>Jaccard Similarity Web</h3>
        <div class="chart-area" id="jaccard-web"></div>
    </div>

    <div id="middle-strip">
        <div id="strip-title">
            <span>DATA VIZ</span>
            <h1>FIGHT<br>SONGS</h1>
        </div>
        <div id="strip-info">
            <div id="info-school">SELECT A SCHOOL</div>
            <div id="info-song">Click dots or logos to explore</div>
            <div class="info-stats" id="info-details" style="opacity: 0;">
                <span>Year: <b id="d-year"></b></span>
                <span>Writers: <b id="d-writer"></b></span>
                <span>Student Written: <b id="d-student"></b></span>
                <span>Contest: <b id="d-contest"></b></span>
            </div>
        </div>
        <div id="strip-player">
            <div style="color: #444; font-size: 0.8em; text-align: center;">Spotify<br>Player</div>
        </div>
    </div>

    <div id="viz3" class="viz-container">
        <h3>Song Topology</h3>
        <div class="chart-area" id="topology-map"></div>
    </div>

    <div id="viz2" class="viz-container">
        <h3>Origin Story <span style="font-size:0.6em; color:#888;">(Centered)</span></h3>
        <div class="chart-area" id="upset-vertical" style="display:flex; justify-content:center;"></div>
    </div>

    <div id="tooltip" class="tooltip"></div>

<script>
    // --- Utils ---
    const getSlug = (name) => name.toLowerCase().replace(/ /g, "_").replace(/[^a-z0-9_]/g, "");
    
    // --- Config ---
    // Brighter Neon Palette
    const confColors = d3.scaleOrdinal()
        .range(["#FF00FF", "#00FF00", "#00FFFF", "#FFFF00", "#FF9900", "#FF0099"]);
    
    const icons = {
        'fight': '\uf6de', 'victory': '\uf091', 'win_won': '\uf005', 
        'victory_win_won': '\uf091', 'rah': '\uf0a1', 'nonsense': '\uf118', 
        'colors': '\uf53f', 'men': '\uf183', 'opponents': '\uf21e', 
        'spelling': '\uf15d', 'student_writer': '\uf19d', 'official_song': '\uf058', 
        'contest': '\uf091'
    };

    d3.csv("fight-songs.csv").then(data => {
        
        // Data Cleanup
        data.forEach(d => {
            d.bpm = +d.bpm;
            d.sec_duration = +d.sec_duration;
            d.number_fights = +d.number_fights;
            d.trope_count = +d.trope_count;
            d.id = d.school;
        });

        const tooltip = d3.select("#tooltip");

        // --- GLOBAL INTERACTION ---
        function updateSelection(schoolName) {
            // Reset if null
            if (!schoolName) {
                d3.selectAll(".dimmed").classed("dimmed", false);
                d3.selectAll(".highlighted").classed("highlighted", false);
                d3.select("#info-school").text("SELECT A SCHOOL");
                d3.select("#info-song").text("Click dots or logos to explore");
                d3.select("#info-details").style("opacity", 0);
                d3.select("#strip-player").html('<div style="color: #444; font-size: 0.8em; text-align: center;">Spotify<br>Player</div>');
                return;
            }

            const d = data.find(r => r.school === schoolName);
            
            // Visual Feedback
            d3.selectAll("circle, .school-logo").classed("dimmed", true).classed("highlighted", false);
            d3.selectAll(`[data-school="${schoolName}"]`).classed("dimmed", false).classed("highlighted", true);

            // Update Middle Strip
            d3.select("#info-school").text(d.school);
            d3.select("#info-song").text(d.song_name);
            d3.select("#info-details").style("opacity", 1);
            d3.select("#d-year").text(d.year);
            d3.select("#d-writer").text(d.writers.length > 20 ? "Various" : d.writers);
            d3.select("#d-student").text(d.student_writer);
            d3.select("#d-contest").text(d.contest);

            // Spotify
            if (d.spotify_id) {
                // Using embed format
                const url = `https://open.spotify.com/embed/track/${d.spotify_id}?utm_source=generator&theme=0`;
                d3.select("#strip-player").html(`<iframe src="${url}" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`);
            }
        }

        // --- VIZ 1: Horizontal UpSet with LOGOS ---
        const drawViz1 = () => {
            const container = document.getElementById('upset-horizontal');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#upset-horizontal").append("svg").attr("width", w).attr("height", h);

            const tropes = ['fight', 'victory', 'win_won', 'rah', 'nonsense', 'colors', 'men', 'opponents', 'spelling'];
            
            // Aggregate
            const combos = {};
            data.forEach(d => {
                const sig = tropes.map(t => d[t] === 'Yes' ? '1' : '0').join("");
                if (!combos[sig]) combos[sig] = { schools: [], sig: sig };
                combos[sig].schools.push(d.school);
            });
            // Top 8 combos to fit vertically
            const sorted = Object.values(combos).sort((a,b) => b.schools.length - a.schools.length).slice(0, 8);
            
            const margin = {top: 10, right: 10, bottom: 80, left: 100}; // Left for Matrix labels
            const innerH = h - margin.top - margin.bottom;
            const rowH = innerH / sorted.length;

            const g = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);

            sorted.forEach((combo, i) => {
                const y = i * rowH;
                const centerY = y + rowH/2;
                
                // Draw Logos
                combo.schools.forEach((school, j) => {
                    // Logo size logic
                    const logoSize = Math.min(rowH - 4, 30);
                    g.append("image")
                        .attr("xlink:href", `logos/${getSlug(school)}.png`)
                        .attr("x", j * (logoSize + 5))
                        .attr("y", centerY - logoSize/2)
                        .attr("width", logoSize)
                        .attr("height", logoSize)
                        .attr("class", "school-logo")
                        .attr("data-school", school)
                        // Fallback color square if image missing (using error handler in real img, hard in SVG)
                        .on("error", function() { d3.select(this).style("display", "none"); }) 
                        .on("mouseover", (e) => {
                            tooltip.style("opacity", 1).html(school)
                                .style("left", (e.pageX + 10) + "px").style("top", (e.pageY - 10) + "px");
                        })
                        .on("mouseout", () => tooltip.style("opacity", 0))
                        .on("click", (e) => { e.stopPropagation(); updateSelection(school); });
                });

                // Matrix Dots (Left Side)
                tropes.forEach((t, k) => {
                    const active = combo.sig[k] === '1';
                    // Text Labels (Only draw once)
                    if (i === sorted.length - 1) {
                         svg.append("text")
                            .attr("x", margin.left - 5 + (k*25) - (tropes.length*25)) // Position left of margin
                            .attr("y", h - 5)
                            .attr("transform", `rotate(-45, ${margin.left + (k*20) - 200}, ${h-10})`) // Simplified rotation
                            // Actually, let's put matrix below like before, simpler for text
                    }
                });
            });

            // Re-doing Matrix to be below the rows, aligned with nothing? 
            // The user wanted horizontal upset. Matrix usually on Left for horizontal bars.
            // Let's put Matrix on the LEFT of the logos.
            
            const matrixG = svg.append("g").attr("transform", `translate(10, ${margin.top})`);
            tropes.forEach((t, k) => {
                // Column Header (Rotated)
                matrixG.append("text")
                    .attr("x", k * 10)
                    .attr("y", -5)
                    .style("font-family", "FontAwesome")
                    .style("font-size", "10px")
                    .text(icons[t])
                    .append("title").text(t); // Tooltip for icon
                
                // Dots
                sorted.forEach((combo, i) => {
                    const active = combo.sig[k] === '1';
                    matrixG.append("circle")
                        .attr("cx", k * 10 + 5)
                        .attr("cy", i * rowH + rowH/2)
                        .attr("r", active ? 3 : 1)
                        .attr("class", active ? "upset-dot active" : "upset-dot");
                });
            });
            
            // Interaction to clear
            svg.on("click", () => updateSelection(null));
        };
        drawViz1();

        // --- VIZ 4: Similarity Web (Bounded) ---
        const drawViz4 = () => {
            const container = document.getElementById('jaccard-web');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#jaccard-web").append("svg").attr("width", w).attr("height", h);

            const nodes = data.map(d => ({...d}));
            const links = [];
            // Recalculate links
            const t = ['victory','win_won','rah','nonsense','colors','men','opponents','spelling'];
            for(let i=0; i<nodes.length; i++) {
                for(let j=i+1; j<nodes.length; j++) {
                    let u=0, inter=0;
                    t.forEach(k => {
                        const a = nodes[i][k]==='Yes'; const b = nodes[j][k]==='Yes';
                        if(a||b) u++; if(a&&b) inter++;
                    });
                    if(u>0 && (inter/u)>0.75) links.push({source:nodes[i].id, target:nodes[j].id});
                }
            }

            const sim = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d=>d.id).distance(30))
                .force("charge", d3.forceManyBody().strength(-50))
                .force("center", d3.forceCenter(w/2, h/2))
                .force("collide", d3.forceCollide().radius(d => 4 + d.trope_count * 1.5));

            const link = svg.append("g").selectAll("line").data(links).enter().append("line")
                .attr("stroke", "#333").attr("stroke-width", 1);
            
            const node = svg.append("g").selectAll("circle").data(nodes).enter().append("circle")
                .attr("r", d => 3 + d.trope_count * 1.5)
                .attr("fill", d => confColors(d.conference))
                .attr("data-school", d => d.school)
                .on("click", (e, d) => { e.stopPropagation(); updateSelection(d.school); })
                .on("mouseover", (e, d) => {
                     tooltip.style("opacity", 1).html(`${d.school}<br>Tropes: ${d.trope_count}`)
                        .style("left", (e.pageX+10)+"px").style("top", (e.pageY-10)+"px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            sim.on("tick", () => {
                // Bounding Box Logic
                node
                    .attr("cx", d => d.x = Math.max(10, Math.min(w - 10, d.x)))
                    .attr("cy", d => d.y = Math.max(10, Math.min(h - 10, d.y)));

                link
                    .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            });
        };
        drawViz4();

        // --- VIZ 3: Topology (With Key) ---
        const drawViz3 = () => {
            const container = document.getElementById('topology-map');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#topology-map").append("svg").attr("width", w).attr("height", h);
            
            const margin = {top: 10, right: 80, bottom: 20, left: 30}; // Right space for Legend
            const iw = w - margin.left - margin.right;
            const ih = h - margin.top - margin.bottom;

            const x = d3.scaleLinear().domain([0, 180]).range([0, iw]);
            const y = d3.scaleLinear().domain([60, 190]).range([ih, 0]);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Density
            const contours = d3.contourDensity().x(d=>x(d.sec_duration)).y(d=>y(d.bpm))
                .size([iw, ih]).bandwidth(15)(data);
            
            g.append("g").selectAll("path").data(contours).enter().append("path")
                .attr("d", d3.geoPath())
                .attr("fill", "#00ffcc").attr("opacity", 0.05);

            // Axes
            g.append("g").attr("transform", `translate(0,${ih})`).call(d3.axisBottom(x).ticks(5).tickSize(-ih).tickFormat(""));
            g.append("g").call(d3.axisLeft(y).ticks(5).tickSize(-iw).tickFormat(""));
            
            // Clean axis lines
            g.selectAll(".tick line").attr("stroke", "#333").attr("stroke-dasharray", "2,2");
            g.selectAll(".domain").remove();

            // Dots
            g.selectAll("circle").data(data).enter().append("circle")
                .attr("cx", d => x(d.sec_duration))
                .attr("cy", d => y(d.bpm))
                .attr("r", d => (d.number_fights + 1) * 2.5)
                .attr("fill", d => d3.interpolateViridis(d.trope_count / 8))
                .attr("stroke", "#000")
                .attr("data-school", d => d.school)
                .on("click", (e, d) => { e.stopPropagation(); updateSelection(d.school); });

            // Legend/Key (Right Side)
            const leg = svg.append("g").attr("transform", `translate(${w - 70}, 20)`);
            leg.append("text").text("KEY").attr("font-weight","bold").attr("fill","#fff").attr("y", -5);
            
            // Size Key
            leg.append("circle").attr("r", 3).attr("cy", 10).attr("fill", "#888");
            leg.append("text").text("0 Fights").attr("x", 10).attr("y", 13).style("font-size", "9px");
            leg.append("circle").attr("r", 10).attr("cy", 30).attr("fill", "#888");
            leg.append("text").text("High Fights").attr("x", 15).attr("y", 33).style("font-size", "9px");

            // Color Key (Gradient)
            const grad = svg.append("defs").append("linearGradient").attr("id", "grad1");
            grad.append("stop").attr("offset", "0%").style("stop-color", d3.interpolateViridis(0));
            grad.append("stop").attr("offset", "100%").style("stop-color", d3.interpolateViridis(1));
            
            leg.append("rect").attr("y", 50).attr("width", 50).attr("height", 6).style("fill", "url(#grad1)");
            leg.append("text").text("Few Tropes").attr("y", 48).style("font-size", "8px");
            leg.append("text").text("Many").attr("y", 48).attr("x", 30).style("font-size", "8px");
        };
        drawViz3();

        // --- VIZ 2: Vertical UpSet (Centered Origin) ---
        const drawViz2 = () => {
            const container = document.getElementById('upset-vertical');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#upset-vertical").append("svg").attr("width", w).attr("height", h);

            const meta = ['student_writer', 'official_song', 'contest'];
            const combos = {};
            data.forEach(d => {
                const sig = meta.map(t => d[t] === 'Yes' ? '1' : '0').join("");
                if (!combos[sig]) combos[sig] = { count: 0, sig: sig };
                combos[sig].count++;
            });
            const sorted = Object.values(combos).sort((a,b) => b.count - a.count);

            // Centering math
            const barW = 30;
            const totalW = sorted.length * barW;
            const startX = (w - totalW) / 2;
            const bottomSpace = 80;
            
            const maxVal = d3.max(sorted, d=>d.count);
            const scale = d3.scaleLinear().domain([0, maxVal]).range([0, h - bottomSpace - 20]);

            const g = svg.append("g").attr("transform", `translate(${startX}, 10)`);

            sorted.forEach((d, i) => {
                // Bar
                g.append("rect")
                    .attr("x", i * barW)
                    .attr("y", h - bottomSpace - scale(d.count))
                    .attr("width", barW - 5)
                    .attr("height", scale(d.count))
                    .attr("fill", "#FF0099");
                
                // Matrix
                meta.forEach((m, j) => {
                    const active = d.sig[j] === '1';
                    g.append("text")
                        .attr("x", i * barW + (barW-5)/2)
                        .attr("y", h - bottomSpace + 20 + (j*20))
                        .attr("text-anchor", "middle")
                        .style("font-family", "FontAwesome")
                        .style("fill", active ? "#00ffcc" : "#333")
                        .text(active ? icons[m] : ".");
                });
            });

            // Labels on left of the centered block
            meta.forEach((m, j) => {
                svg.append("text")
                    .attr("x", startX - 10)
                    .attr("y", 10 + h - bottomSpace + 20 + (j*20))
                    .attr("text-anchor", "end")
                    .text(m.replace("_", " "))
                    .style("font-size", "10px");
            });
        };
        drawViz2();

    });
</script>
</body>
</html>
