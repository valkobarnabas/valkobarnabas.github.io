<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Geometry of Fight Songs</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-contour.v4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #050b14; 
            --card-bg: #0b1626;
            --text-color: #ffffff;
            --highlight: #00f2ff; /* Cyan for UI elements */
            --accent: #ff00ff; /* Hot Pink for Selection */
            --dim: #4a5d75;
            --border: 1px solid rgba(0, 242, 255, 0.2);
            --grey-dim: #3a3a3a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: grid;
            /* Ratio: 3.5 (Top) : 2 (Strip) : 3.5 (Bottom) */
            grid-template-rows: 3.5fr 2fr 3.5fr; 
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            overflow: hidden; 
        }

        /* --- Grid Areas --- */
        #viz1 { grid-column: 1 / 2; grid-row: 1 / 2; } /* Top Left */
        #viz4 { grid-column: 2 / 3; grid-row: 1 / 2; } /* Top Right */
        
        #middle-strip {
            grid-column: 1 / 3;
            grid-row: 2 / 3;
            display: grid;
            grid-template-columns: 350px 1fr;
            background: #08101c;
            border-top: 2px solid var(--highlight);
            border-bottom: 2px solid var(--highlight);
            overflow: hidden;
            min-height: 0; 
        }

        #viz3 { grid-column: 1 / 2; grid-row: 3 / 4; } /* Bottom Left */
        #viz2 { grid-column: 2 / 3; grid-row: 3 / 4; } /* Bottom Right */

        /* --- Containers --- */
        .viz-container {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 10px;
            border: var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-height: 0;
        }

        h3 { 
            margin: 0 0 5px 0; 
            color: var(--highlight); 
            font-weight: 600; 
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--dim);
            padding-bottom: 5px;
            display: flex; justify-content: space-between;
            flex-shrink: 0;
        }
        
        .chart-area { flex-grow: 1; position: relative; overflow: hidden; width: 100%; height: 100%; }

        /* --- Middle Strip --- */
        #strip-left {
            padding: 0 30px;
            border-right: 1px solid var(--dim);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            white-space: nowrap;
        }
        .sub-top { font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        
        /* Responsive Title */
        .main-title { 
            font-size: clamp(1.2rem, 2.5vw, 2em); 
            color: var(--highlight); 
            font-weight: 800; 
            line-height: 1.1; 
            margin: 0; 
            text-transform: uppercase; 
        }
        
        .sub-bot { font-size: 1em; color: #fff; margin-top: 5px; font-weight: 300; display: flex; align-items: center; gap: 10px; }
        
        .about-link {
            font-size: 0.7em;
            background: var(--dim);
            padding: 2px 8px;
            border-radius: 10px;
            cursor: pointer;
            color: #ccc;
            text-decoration: none;
            transition: all 0.2s;
        }
        .about-link:hover { background: var(--highlight); color: #000; }

        /* Right Panel */
        #strip-right {
            display: flex;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #placeholder-msg {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--dim);
            font-style: italic;
        }

        #active-content {
            display: none;
            width: 100%;
            height: 100%;
            display: flex; 
        }

        #song-info-panel {
            flex: 1; 
            padding: 10px 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start; 
            text-align: left;        
            min-width: 0; 
        }

        #spotify-panel {
            flex: 0 0 450px; 
            background: #000;
            border-left: 1px solid var(--dim);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }

        iframe { width: 100%; height: 152px; border: none; border-radius: 12px; }

        #si-school-row { font-size: 2em; font-weight: 800; color: #fff; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        #si-title { font-size: 1.3em; color: var(--accent); margin: 5px 0 10px 0; font-style: italic; }
        
        .badges { display: flex; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; justify-content: flex-start; }
        .badge { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: #ccc; display: flex; align-items: center; gap: 5px; }
        .badge i { color: var(--highlight); }

        .stats-row { display: flex; gap: 20px; font-size: 0.9em; color: #aaa; justify-content: flex-start; }
        .stats-row b { color: #fff; }

        /* --- Viz Elements --- */
        .node circle { stroke: #fff; stroke-width: 1px; cursor: pointer; transition: all 0.2s; }
        .node circle:hover { stroke: var(--highlight); stroke-width: 4px; filter: drop-shadow(0 0 8px var(--highlight)); }
        
        /* Highlight States */
        /* Dimmed nodes turn grey but stay visible */
        .dimmed { fill: var(--grey-dim) !important; opacity: 0.6 !important; stroke: #222 !important; }
        
        /* Highlighted nodes turn Pink */
        .highlighted { 
            fill: var(--accent) !important; 
            stroke: #fff !important; 
            stroke-width: 3px !important; 
            opacity: 1 !important; 
            filter: drop-shadow(0 0 8px var(--accent)) !important;
            r: 8px !important; /* Slight pop */
        }
        
        .logo-dimmed { opacity: 0.2; filter: grayscale(100%); }
        .logo-highlighted { filter: drop-shadow(0 0 8px var(--highlight)); transform: scale(1.2); opacity: 1; z-index: 10; }

        /* Rect Highlight */
        rect { transition: fill 0.2s; }
        rect.highlighted { fill: var(--accent) !important; opacity: 1 !important; stroke: none !important; }
        rect.dimmed { fill: var(--grey-dim) !important; opacity: 0.5 !important; }

        /* Logos */
        .school-logo { cursor: pointer; transition: transform 0.2s; }
        .school-logo:hover { transform: scale(1.4); z-index: 100; filter: drop-shadow(0 0 5px white); }

        /* UpSet Dots */
        .upset-dot { fill: #333; }
        .upset-dot.active { fill: var(--accent); stroke: none; }
        .upset-dot.dimmed { fill: #222 !important; } /* Dim non-active dots */

        /* Tooltips */
        .tooltip {
            position: absolute;
            background: rgba(0, 18, 32, 0.95);
            padding: 8px 12px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 9999;
            border: 1px solid var(--highlight);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            font-size: 0.9em;
            color: #fff;
            max-width: 250px;
        }
        
        /* About Modal */
        #about-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            border: 2px solid var(--highlight);
            color: #fff;
            position: relative;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em; color: #888; }
        .close-btn:hover { color: #fff; }

        text { fill: #aaa; font-size: 11px; }
        .axis-label { font-size: 12px; font-weight: bold; fill: #fff; }
    </style>
</head>
<body>

    <div id="viz1" class="viz-container">
        <h3>Lyrical Ingredients <span style="font-size:0.7em; color:#666;">Select Logo to Reveal Tropes</span></h3>
        <div class="chart-area" id="lyrical-panel" style="display:flex; height: 100%;">
            <div id="logo-grid" style="flex: 0 0 50%; overflow-y: auto; padding-right: 10px;"></div>
            <div id="trope-dashboard" style="flex: 1; border-left: 1px solid #333; padding-left: 10px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div style="color:#666; font-style:italic;">Select a team<br>to view ingredients</div>
            </div>
        </div>
    </div>

    <div id="viz4" class="viz-container">
        <h3>Trope Network <span style="font-size:0.7em; color:#666;">Linked by Content</span></h3>
        <div class="chart-area" id="jaccard-web"></div>
    </div>

    <div id="middle-strip">
        <div id="strip-left">
            <div class="sub-top">Bucky's Data Viz Challenge</div>
            <div class="main-title">The Geometry of Fight Songs</div>
            <div class="sub-bot">
                Barnabás Valkó 
                <span class="about-link" onclick="document.getElementById('about-modal').style.display='flex'; event.stopPropagation();">About This Page</span>
            </div>
        </div>

        <div id="strip-right">
            <div id="placeholder-msg">Select a school to analyze</div>
            
            <div id="active-content">
                <div id="song-info-panel">
                    <div id="si-school-row">
                        <span id="si-school"></span> <span id="si-conf" style="font-size: 0.5em; color: #888; font-weight: normal;"></span>
                    </div>
                    <div id="si-title"></div>
                    
                    <div class="badges" id="si-badges"></div>
                    
                    <div class="stats-row">
                        <span>Year: <b id="si-year"></b></span>
                        <span>Writers: <b id="si-writers"></b></span>
                    </div>
                </div>
                
                <div id="spotify-panel"></div>
            </div>
        </div>
    </div>

    <div id="viz3" class="viz-container">
        <h3>Song Topology <span style="font-size:0.7em; color:#666;">Tempo & Duration</span></h3>
        <div class="chart-area" id="topology-map"></div>
    </div>

    <div id="viz2" class="viz-container">
        <h3>Origin Story <span style="font-size:0.7em; color:#666;">Metadata</span></h3>
        <div class="chart-area" id="upset-origin"></div>
    </div>

    <div id="tooltip" class="tooltip"></div>
    
    <div id="about-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('about-modal').style.display='none'">×</span>
            <h2 style="color:var(--highlight); margin-top:0;">About This Dashboard</h2>
            <p>This visualization explores the hidden structure of college fight songs using data from FiveThirtyEight.</p>
            <ul>
                <li><strong>Lyrical Ingredients:</strong> Select a school logo to see which tropes (words like "Fight", "Victory", "Rah") appear in its lyrics.</li>
                <li><strong>Trope Network:</strong> A graph where schools are connected if their lyrics are >75% similar. Nodes cluster by content.</li>
                <li><strong>Song Topology:</strong> A map of song speed (BPM) vs length. Color represents the total number of tropes used.</li>
                <li><strong>Origin Story:</strong> Shows how the songs were born—whether by students, contests, or official decree.</li>
            </ul>
            <p style="font-size:0.9em; color:#888;">Built with D3.js by Barnabás Valkó.</p>
        </div>
    </div>

<script>
    // --- Utils ---
    const getSlug = (name) => name.toLowerCase().replace(/ /g, "_").replace(/[^a-z0-9_]/g, "");

    // --- Config ---
    const icons = {
        'fight': '\uf6de', 'victory': '\uf091', 'win_won': '\uf005', 
        'rah': '\uf0a1', 'nonsense': '\uf118', 'colors': '\uf53f', 
        'men': '\uf183', 'opponents': '\uf21e', 'spelling': '\uf15d',
        'student_writer': '\uf19d', 'official_song': '\uf058', 'contest': '\uf091'
    };
    
    const iconLabels = {
        'fight': 'Fight', 'victory': 'Victory', 'win_won': 'Win', 
        'rah': 'Rah', 'nonsense': 'Nonsense', 'colors': 'Colors', 
        'men': 'Men', 'opponents': 'Foes', 'spelling': 'Spell',
        'student_writer': 'Student Author', 'official_song': 'Official Song', 'contest': 'Contest Winner'
    };
    
    const row1 = ['fight', 'victory', 'win_won', 'rah'];
    const row2 = ['nonsense', 'colors', 'men', 'opponents', 'spelling'];

    // Deep Blue -> Light Blue
    const tropeColorScale = d3.scaleLinear()
        .domain([0, 8])
        .range(["#000055", "#00BFFF"]); 

    const confColors = d3.scaleOrdinal()
        .domain(['Big 12', 'Big Ten', 'ACC', 'SEC', 'Pac-12', 'Independent'])
        .range(["#FF00FF", "#00FFFF", "#FFFF00", "#FF4400", "#00FF00", "#FFFFFF"]);

    d3.csv("fight-songs.csv").then(data => {
        
        // --- Data Cleanup ---
        data.forEach(d => {
            for(let key in d) { if(typeof d[key] === 'string') d[key] = d[key].trim(); }
            d.bpm = +d.bpm;
            d.sec_duration = +d.sec_duration;
            d.number_fights = +d.number_fights;
            d.trope_count = +d.trope_count;
            d.id = d.school;
        });

        const tooltip = d3.select("#tooltip");

        // --- GLOBAL RESET ---
        d3.selectAll(".chart-area").on("click", function(e) {
            if(e.target === this || e.target.tagName === 'svg') updateSelection(null);
        });

        // --- UPDATE FUNCTION ---
        function updateSelection(schoolName) {
            if (!schoolName) {
                // Reset Visuals (Undim everything)
                d3.selectAll(".dimmed").classed("dimmed", false);
                d3.selectAll(".highlighted").classed("highlighted", false);
                d3.selectAll(".logo-dimmed").classed("logo-dimmed", false);
                d3.selectAll(".logo-highlighted").classed("logo-highlighted", false);
                d3.selectAll("rect").classed("highlighted", false).classed("dimmed", false).attr("fill", "#444");

                // Reset Panels
                d3.select("#placeholder-msg").style("display", "flex");
                d3.select("#active-content").style("display", "none");
                d3.select("#spotify-panel").html("");
                d3.select("#trope-dashboard").html('<div style="color:#666; font-style:italic;">Select a team<br>to view ingredients</div>');
                return;
            }

            const d = data.find(r => r.school === schoolName);

            // 1. Visual States (Dim Everything first)
            d3.selectAll("circle").classed("dimmed", true).classed("highlighted", false);
            d3.selectAll(".school-logo").classed("logo-dimmed", true).classed("logo-highlighted", false);
            d3.selectAll("rect").classed("dimmed", true).classed("highlighted", false);

            // 2. Highlight Specifics
            // Nodes (Topology & Network)
            d3.selectAll(`circle[data-school="${schoolName}"]`).classed("dimmed", false).classed("highlighted", true);
            
            // Logo
            d3.selectAll(`.school-logo[data-school="${schoolName}"]`).classed("logo-dimmed", false).classed("logo-highlighted", true);

            // Origin Bars (Find bar containing school)
            d3.selectAll("#upset-origin rect").each(function() {
                const schools = JSON.parse(d3.select(this).attr("data-schools") || "[]");
                if (schools.includes(schoolName)) {
                    d3.select(this)
                        .classed("dimmed", false)
                        .classed("highlighted", true); 
                }
            });
            // Also keep upset dots visible for highlighted bars
            d3.selectAll(".upset-dot").classed("dimmed", false); 


            // 3. Middle Strip Info
            d3.select("#placeholder-msg").style("display", "none");
            d3.select("#active-content").style("display", "flex");

            d3.select("#si-school").text(d.school);
            d3.select("#si-conf").text(`(${d.conference})`);
            d3.select("#si-title").text(d.song_name);
            d3.select("#si-year").text(d.year);
            d3.select("#si-writers").text(d.writers.length > 30 ? "Multiple" : d.writers);

            let badgesHTML = "";
            if(d.student_writer === "Yes") badgesHTML += `<div class="badge"><i class="fas fa-graduation-cap"></i> Student</div>`;
            if(d.contest === "Yes") badgesHTML += `<div class="badge"><i class="fas fa-trophy"></i> Contest</div>`;
            if(d.official_song === "Yes") badgesHTML += `<div class="badge"><i class="fas fa-check-circle"></i> Official</div>`;
            d3.select("#si-badges").html(badgesHTML);

            if (d.spotify_id) {
                const url = `https://open.spotify.com/embed/track/${d.spotify_id}?utm_source=generator&theme=0`;
                d3.select("#spotify-panel").html(`<iframe src="${url}" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`);
            } else {
                d3.select("#spotify-panel").html(`<div style="color:#444;">No Audio</div>`);
            }

            // 4. Update Trope Dashboard
            drawTropeDashboard(d);
        }

        // --- VIZ 1: Grid + Dashboard ---
        function initViz1() {
            const gridDiv = d3.select("#logo-grid");
            const logoSize = 32;
            
            const container = gridDiv.append("div")
                .style("display", "flex")
                .style("flex-wrap", "wrap")
                .style("gap", "6px")
                .style("justify-content", "center")
                .style("padding-top", "10px");

            const sortedData = [...data].sort((a,b) => d3.ascending(a.school, b.school));

            container.selectAll("img")
                .data(sortedData)
                .enter().append("img")
                .attr("src", d => `logos/${getSlug(d.school)}.png`)
                .attr("width", logoSize).attr("height", logoSize)
                .attr("class", "school-logo")
                .attr("data-school", d => d.school)
                .attr("title", d => d.school)
                .style("border-radius", "4px")
                .on("click", (e, d) => { e.stopPropagation(); updateSelection(d.school); })
                .on("error", function() { this.style.display='none'; });
        }

        function drawTropeDashboard(d) {
            const container = d3.select("#trope-dashboard");
            container.html(""); // Clear

            const wrapper = container.append("div")
                .style("display", "flex")
                .style("flex-direction", "column")
                .style("gap", "20px")
                .style("width", "100%");

            const createRow = (keys) => {
                const rowDiv = wrapper.append("div")
                    .style("display", "flex")
                    .style("justify-content", "space-around")
                    .style("width", "100%");
                
                keys.forEach(key => {
                    const hasTrope = d[key] === 'Yes';
                    const cell = rowDiv.append("div")
                        .style("display", "flex").style("flex-direction", "column").style("align-items", "center")
                        .style("opacity", hasTrope ? 1 : 0.2);

                    // Icon
                    cell.append("div")
                        .style("font-family", "FontAwesome").style("font-size", "22px").style("color", "#00f2ff").style("margin-bottom", "5px")
                        .text(icons[key]);
                    
                    // Label
                    cell.append("div")
                        .style("font-size", "9px").style("color", "#aaa").style("margin-bottom", "5px")
                        .text(iconLabels[key]);

                    // Circle
                    const circle = cell.append("div")
                        .style("width", "20px").style("height", "20px")
                        .style("border-radius", "50%")
                        .style("border", "2px solid " + (hasTrope ? "#00f2ff" : "#444"))
                        .style("background", hasTrope ? "rgba(0, 242, 255, 0.2)" : "transparent")
                        .style("display", "flex").style("align-items", "center").style("justify-content", "center")
                        .style("font-size", "10px").style("color", "#fff").style("font-weight", "bold");

                    if (key === 'fight' && hasTrope) {
                        circle.text(d.number_fights);
                    }
                });
            };

            createRow(row1); // 4 items
            createRow(row2); // 5 items
        }
        initViz1();


        // --- VIZ 4: Trope Network ---
        const drawViz4 = () => {
            const container = document.getElementById('jaccard-web');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#jaccard-web").append("svg").attr("width", w).attr("height", h);

            const graphW = w * 0.8; 
            const legendX = w * 0.82; 

            const nodes = data.map(d => ({...d}));
            const links = [];
            const t = ['victory','win_won','rah','nonsense','colors','men','opponents','spelling'];
            for(let i=0; i<nodes.length; i++) {
                for(let j=i+1; j<nodes.length; j++) {
                    let u=0, inter=0;
                    t.forEach(k => {
                        const a = nodes[i][k]==='Yes'; const b = nodes[j][k]==='Yes';
                        if(a||b) u++; if(a&&b) inter++;
                    });
                    if(u>0 && (inter/u) > 0.75) links.push({source:nodes[i].id, target:nodes[j].id});
                }
            }

            const g = svg.append("g");
            g.selectAll("line").data(links).enter().append("line")
                .attr("stroke", "#555").attr("stroke-width", 1).attr("opacity", 0.5);

            const node = g.selectAll("circle").data(nodes).enter().append("circle")
                .attr("r", 5) // Fixed Size
                .attr("fill", d => confColors(d.conference))
                .attr("stroke", "#000")
                .attr("data-school", d => d.school)
                .on("click", (e, d) => { e.stopPropagation(); updateSelection(d.school); })
                .on("mouseover", (e, d) => {
                     tooltip.style("opacity", 1).html(`${d.school}<br>${d.conference}`)
                        .style("left", (e.pageX+10)+"px").style("top", (e.pageY-10)+"px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d=>d.id).strength(0.5))
                .force("charge", d3.forceManyBody().strength(-30))
                .force("center", d3.forceCenter(graphW/2, h/2))
                .force("collide", d3.forceCollide().radius(8));

            simulation.on("tick", () => {
                node.attr("cx", d => d.x = Math.max(10, Math.min(graphW - 10, d.x)))
                    .attr("cy", d => d.y = Math.max(10, Math.min(h - 10, d.y)));
                g.selectAll("line")
                    .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            });

            // Legend
            const legend = svg.append("g").attr("transform", `translate(${legendX}, 20)`);
            legend.append("text").text("CONFERENCE").attr("font-weight","bold").attr("fill","#fff").attr("y", -10);
            confColors.domain().forEach((c, i) => {
                const lg = legend.append("g").attr("transform", `translate(0, ${i*18})`);
                lg.append("circle").attr("r", 5).attr("fill", confColors(c)).attr("stroke", "#000");
                lg.append("text").attr("x", 12).attr("y", 4).text(c).style("font-size", "10px").style("fill", "#ccc");
            });
            
            // BG Click Reset
            svg.on("click", (e) => { if(e.target === svg.node()) updateSelection(null); });
        };
        drawViz4();


        // --- VIZ 3: Topology (Dark Blue -> Light Blue) ---
        const drawViz3 = () => {
            const container = document.getElementById('topology-map');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#topology-map").append("svg").attr("width", w).attr("height", h);
            
            const margin = {top: 10, right: 110, bottom: 30, left: 40};
            const iw = w - margin.left - margin.right;
            const ih = h - margin.top - margin.bottom;

            const x = d3.scaleLinear().domain([0, 180]).range([0, iw]);
            const y = d3.scaleLinear().domain([60, 190]).range([ih, 0]);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Density
            const contours = d3.contourDensity().x(d=>x(d.sec_duration)).y(d=>y(d.bpm))
                .size([iw, ih]).bandwidth(15)(data);
            g.append("g").selectAll("path").data(contours).enter().append("path")
                .attr("d", d3.geoPath()).attr("fill", "#00f2ff").attr("opacity", 0.08);

            // Axes
            g.append("g").attr("transform", `translate(0,${ih})`).call(d3.axisBottom(x).ticks(5));
            g.append("g").call(d3.axisLeft(y).ticks(5));
            g.selectAll(".domain, .tick line").attr("stroke", "#444");
            g.append("text").attr("class", "axis-label").attr("x", iw).attr("y", ih - 5).attr("text-anchor", "end").text("Duration (sec)");
            g.append("text").attr("class", "axis-label").attr("x", 10).attr("y", 15).text("BPM");

            // Dots (Uniform Size, Blue Gradient Color)
            g.selectAll("circle").data(data).enter().append("circle")
                .attr("cx", d => x(d.sec_duration))
                .attr("cy", d => y(d.bpm))
                .attr("r", 5) 
                .attr("fill", d => tropeColorScale(d.trope_count))
                .attr("stroke", "#000")
                .attr("data-school", d => d.school)
                .on("mouseover", (e, d) => {
                     tooltip.style("opacity", 1).html(
                         `<b>${d.school}</b><br>
                          BPM: ${d.bpm}<br>
                          Duration: ${d.sec_duration}s<br>
                          Tropes: ${d.trope_count}`
                     ).style("left", (e.pageX+10)+"px").style("top", (e.pageY-10)+"px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0))
                .on("click", (e, d) => { e.stopPropagation(); updateSelection(d.school); });

            // Key
            const leg = svg.append("g").attr("transform", `translate(${w - 100}, 20)`);
            leg.append("text").text("KEY").attr("fill","#fff").attr("font-weight","bold").attr("y", -5);
            
            leg.append("text").text("Trope Count").attr("y", 15).style("font-size","9px").style("fill","#00f2ff");
            
            const grad = svg.append("defs").append("linearGradient").attr("id", "gradTrope");
            grad.append("stop").attr("offset", "0%").style("stop-color", "#000055");
            grad.append("stop").attr("offset", "100%").style("stop-color", "#00BFFF");
            
            leg.append("rect").attr("y", 25).attr("width", 70).attr("height", 8).style("fill", "url(#gradTrope)");
            leg.append("text").text("0").attr("y", 45).attr("x", 0);
            leg.append("text").text("8+").attr("y", 45).attr("x", 65);
            
            svg.on("click", (e) => { if(e.target === svg.node()) updateSelection(null); });
        };
        drawViz3();


        // --- VIZ 2: Origin Story ---
        const drawViz2 = () => {
            const container = document.getElementById('upset-origin');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const svg = d3.select("#upset-origin").append("svg").attr("width", w).attr("height", h);

            const meta = ['student_writer', 'official_song', 'contest'];
            const combos = {};
            data.forEach(d => {
                const sig = meta.map(t => d[t] === 'Yes' ? '1' : '0').join("");
                if (!combos[sig]) combos[sig] = { count: 0, sig: sig, schools: [] };
                combos[sig].count++;
                combos[sig].schools.push(d.school);
            });
            const sorted = Object.values(combos).sort((a,b) => b.count - a.count);

            const margin = {top: 45, right: 10, bottom: 5, left: 10};
            const rowH = (h - margin.top - margin.bottom) / sorted.length;
            const matrixWidth = w * 0.4; 
            const barAreaWidth = w * 0.6;
            const maxVal = d3.max(sorted, d=>d.count);
            const barScale = d3.scaleLinear().domain([0, maxVal]).range([0, barAreaWidth - 40]);

            const g = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);

            // Headers (Icons + Labels)
            const headerG = svg.append("g").attr("transform", `translate(${margin.left + barAreaWidth}, ${margin.top - 10})`);
            const colW = matrixWidth / meta.length;
            meta.forEach((m, i) => {
                const x = i * colW + colW/2;
                headerG.append("text").attr("x", x).attr("y", -20).attr("text-anchor", "middle")
                    .style("font-family", "FontAwesome").style("font-size", "14px").style("fill", "#ff00ff").text(icons[m]);
                // Restore Labels!
                const labelWords = iconLabels[m].split(" ");
                labelWords.forEach((word, idx) => {
                    headerG.append("text").attr("x", x).attr("y", -8 + (idx*9)).attr("text-anchor", "middle")
                        .style("font-size", "9px").style("fill", "#bbb").text(word);
                });
            });

            sorted.forEach((d, i) => {
                const y = i * rowH;
                const centerY = y + rowH/2;

                // Bar
                g.append("rect")
                    .attr("x", barAreaWidth - barScale(d.count) - 10)
                    .attr("y", centerY - 8).attr("width", barScale(d.count)).attr("height", 16)
                    .attr("fill", "#444") 
                    .attr("data-schools", JSON.stringify(d.schools))
                    .on("mouseover", function(e) { 
                         if(!d3.select(this).classed("highlighted")) d3.select(this).attr("fill", "#888");
                         const names = d.schools.slice(0, 10).join(", ") + (d.schools.length > 10 ? "..." : "");
                         tooltip.style("opacity", 1).html(`<b>${d.count} Schools</b><br>${names}`)
                                .style("left", (e.pageX+10)+"px").style("top", (e.pageY-10)+"px");
                    })
                    .on("mouseout", function() { 
                        if(!d3.select(this).classed("highlighted")) d3.select(this).attr("fill", "#444"); 
                        tooltip.style("opacity", 0);
                    });
                
                g.append("text").attr("x", barAreaWidth - barScale(d.count) - 15).attr("y", centerY + 4).attr("text-anchor", "end").text(d.count);
                g.append("line").attr("x1", barAreaWidth).attr("x2", w).attr("y1", centerY).attr("y2", centerY).attr("stroke", "#333");
                
                meta.forEach((m, k) => {
                    const active = d.sig[k] === '1';
                    // Active Dots are ALWAYS pink
                    g.append("circle").attr("cx", barAreaWidth + (k * colW) + colW/2).attr("cy", centerY).attr("r", active ? 5 : 2)
                     .attr("class", active ? "upset-dot active" : "upset-dot")
                     .style("fill", active ? "#ff00ff" : "#333");
                });
            });
            svg.on("click", (e) => { if(e.target === svg.node()) updateSelection(null); });
        };
        drawViz2();

    });
</script>
</body>
</html>
